<!DOCTYPE html>
<html>
<head>
  <title>Assignment 1</title>
  <meta charset="UTF-8">
  <script type="text/javascript" src="jquery.min.js"></script>
  <style type="text/css">
  body {
    margin-left: 120px;
    margin-right: 120px;
  }
  .document {
    width: 20%;
    float:left;
  }
  .result {
    width: 100%;
    height: 300px;
  }

  .overlay {
    background-color: #ffffff;
    position:absolute;
    padding: 8px;
    top:0;
    left:0;
    width:100%;
    height:100%;
    z-index:1000;
  }
  </style>


  <script type="text/javascript">

    var docSources =  [{name:'BeautifulMind'        ,relevant:false},
                       {name:'Gladiator'            ,relevant:false},
                       {name:'Gravity'              ,relevant:true},
                       {name:'Hobbit1'              ,relevant:false},
                       {name:'Interstellar'         ,relevant:true},
                       {name:'Prometheus'           ,relevant:false},
                       {name:'ResidentEvil'         ,relevant:false},
                       {name:'StarWars'             ,relevant:false},
                       {name:'TheFaultInOurStars'   ,relevant:false},
                       {name:'Titanic'              ,relevant:false}];

    var docPath = 'https://raw.githubusercontent.com/spicydog/CPE671-Search-Engine-and-Internet-Mining/master/Assignment%202/data/{NAME}.txt';

  </script>
</head>
<body>

<div id="loading" class="overlay">Loading documents from the internet..</div>


<div id="Documents">
<h3>Documents</h3>
<div id="source"></div>
<button id="run_index">DO INDEX!</button>
<hr />
</div>


<div id="step0">
<h3>Step 0: Raw Data</h3>
<textarea class="result" id="result_step0">THE FROG-PRINCE
</textarea>
<button id="run1">Run Step 1</button>
<hr />
</div>

<div id="step1">
  <h3>Step 1: Normalize the text by (1) convert all letters to lowercase letters</h3>
  <textarea class="result" id="result_step1"></textarea>
  <button id="run2">Run Step 2</button>
  <hr />
</div>

<div id="step2">
  <h3>Step 2: Remove other symbols, for examples “.”, “:”, “!”, and others</h3>
  <textarea class="result" id="result_step2"></textarea>
  <input type="text" value="30" id="n_dictionary_row" />
  <button id="run3">Run Step 3</button>
  <hr />
</div>

<div id="step3">
  <h3>Step 3: Tokenize the normalized text into tokens and their location. Print out some
  location on the text file to show that it works.</h3>
  <textarea class="result" id="result_step3"></textarea>
  <hr />
</div>

<div id="step4">
  <h3>Step 4: Implement the in-memory array-based version of inverted indices presented in
  the lecture using the binary search of the next method. Show that the next
  method works.</h3>
  Find next index of <input id="word_of_next" type="text" placeholder="word" />
  from index  <input id="index_of_next" type="text" placeholder="index" />
  <button id="run4">Search!</button><br /><br />
  <pre id="result_step4"></pre>
  <hr />
</div>

<div id="step5">
  <h3>Step 5: Use your implementation of inverted indices, implement the basic phrase
  search algorithm presented in the lecture. Show that it works by printing out some results.</h3>
  Search phrase <input id="phrase" type="text" placeholder="phrase" />
  <button id="run5">Search!</button><br /><br />
  <pre id="result_step5"></pre>
  <hr />
</div>







<script type="text/javascript">

  var docCount = 0;
  requestRawDocumentFromSources();
  function requestRawDocumentFromSources() {
    docCount = 0;
    $('#source').html('');

    $.ajaxPrefilter( function (options) {
      if (options.crossDomain && jQuery.support.cors) {
        var http = (window.location.protocol === 'http:' ? 'http:' : 'https:');
        options.url = http + '//cors-anywhere.herokuapp.com/' + options.url;
      }
    });


    jQuery.ajaxSetup({async:false});
    for(var i in docSources) {
      var docSource = docSources[i];
      var fullDocPath = docPath.replace('{NAME}',docSource.name);

      if(localStorage.getItem(fullDocPath) && typeof(Storage) !== "undefined") { // Cache hit
        printSource(docSource.name,localStorage.getItem(fullDocPath),docSource.relevant);
      } else {
        $.get(fullDocPath,function (response) { // Request from internet
          if(typeof(Storage) !== "undefined") {
            localStorage.setItem(fullDocPath, response);
          }
          printSource(docSource.name,response,docSource.relevant);
        });
      }
    }
    jQuery.ajaxSetup({async:true});
    $('#loading').hide();
  }

  function printSource(name, text, isRelevance) {
    var html = '';
    var checked = isRelevance?'checked':'';
    html += '<div class="document">';
    html += '<input type="checkbox" id="relevance_'+name+'" '+checked+'>' + name;
    html += ' <br />';
    html += ' <textarea style="width:100%;height:100px;" id="document_'+name+'">'+text+'</textarea>';
    html += '</div>';

    if(++docCount%5==0) {
      html += '<div style="clear: both;"><br /></div>';
    }
    $('#source').append(html);
  }


  var indexedData;
  var dictionary;

  var documents = [];


  // Index documents
  $('#run_index').click(function() {
    // Do index

    globalDictionary = new Array();
    currentWordIndex = 0;

    $("textarea[id^='document_']").each(function(index) {

      var data = $(this).val();
      data = convertLowerCase(data);
      data = filterSymbols(data);
      documents[index] = data;

      var tokens = tokenize(data,globalDictionary);


    });

    console.log(globalDictionary);

  });

  var globalDictionary = new Array();
  var currentWordIndex = 0;

  function tokenize(data, dictionary) {
    var lines = data.split("\n");
    var k = 0;
    var lineNo = 0;

    var words = data.split(" ");

    var nextIndex = currentWordIndex;

    for(var i in words) {
      var word = words[i];
      var index = 0;
      if(dictionary[word] === undefined) {
        dictionary[word] = new Array();
      } else {
        index = dictionary[word].length;
      }
      dictionary[word][index] = nextIndex;
      nextIndex++;
    }


    var fromIndex = currentWordIndex;
    var toIndex = nextIndex;
    currentWordIndex = nextIndex;

    return [fromIndex,toIndex];
  }

  // Step 3: Tokenization
  $('#run3').click(function() {
    var tokens = tokenize(data);
    dictionary = tokens[1];
    indexedData = tokens[0];
    var nRow = $("#n_dictionary_row").val();
    $("#result_step3").html(printDictionary(dictionary,nRow));
  });


  // Step 4: Next function
  $('#run4').click(function() {
    var fromIndex = parseInt($('#index_of_next').val());
    fromIndex = isNaN(fromIndex) ? 0 : fromIndex;
    var word = $('#word_of_next').val();

    if(word.length>0) {
      resultIndex = next(dictionary[word],fromIndex);
      if(resultIndex==-1) {
        resultIndex = 'Word not found';
      } else if(resultIndex==-2) {
        resultIndex = 'Exceed last index';
      }
      $("#result_step4").html( resultIndex );
    }
  });


  // Step 5: Search phrase
  $('#run5').click(function() {
    var phrase = $('#phrase').val();
    var addition = 3;
    if(phrase.length>0) {
      var resultIndeces = searchParse(phrase)
      var resultString = "";
      for(var i in resultIndeces) {
        var resultIndex = resultIndeces[i];
        for(var j = resultIndex[0]-addition ; j<resultIndex[resultIndex.length-1]+1+addition ; j++) {
          if(j<0 || j>=indexedData.length) {
            continue;
          }

          if(j == resultIndex[0]) {
            resultString += '<strong>';
          }
          resultString += indexedData[j];

          if(j == resultIndex[resultIndex.length-1]) {
            resultString += '</strong>';
          }
          resultString += " ";

        }
        resultString += "\n";
      }
      $("#result_step5").html( resultString );
    }
  });


  function convertLowerCase(string) {
    return string.toLowerCase();
  }

  function searchParse(phrase) {
  	phrase = phrase.trim();
    phrase = convertLowerCase(phrase);
    phrase = filterSymbols(phrase);
    words = phrase.split(" ");

    var firstWordIndex = -1;
    var result = new Array();
    while(true) {

      firstWordIndex = next(dictionary[ words[0] ], firstWordIndex);
      if(firstWordIndex<0) {
        break;
      }

      var foundFlag = true;
      for(var i=1;i<words.length;i++) {
        if( next(dictionary[ words[i] ], firstWordIndex+i-1) != firstWordIndex+i ) {
          foundFlag = false;
          break;
        }
      }

      if(foundFlag) {
        var temp = new Array();
        for(var i=0;i<words.length;i++) {
          temp.push(firstWordIndex+i);
        }
        result.push(temp);
      }

      firstWordIndex++;
    }
    return result;
  }


  function next(array,fromIndex) {

    fromIndex += 1;
    // No data
    if(array==undefined || array.length==0) {
      return -1;
    }

    var count = array.length;
    // Only one element
    if(count==1) {
      return array[0] >= fromIndex ? array[0] : -2;
    }

    // Exceed last index
    if(array[count-1] < fromIndex) {
      return -2;
    }

    var begin = 0;
    var end = count-1;
    var pivot = Math.floor((end+begin)/2);

    while(begin<end) {
      if(fromIndex < array[pivot]) {
        end = pivot;
      } else if(fromIndex > array[pivot]) {
        begin = pivot+1;
      } else {
        begin = pivot;
        end = pivot;
      }
      pivot = Math.floor((end+begin)/2);
    }

    return array[pivot];
  }


  function filterSymbols(data) {
    data = data.replace(/[^a-z 0-9]/gi,'');
    return data;
  }


  function printDictionary(dictionary,n) {
    var result = "";
    for(word in dictionary) {
      if(n--<=0)
        break;

      var positions = dictionary[word];
      result += word + " ("+ positions.length +")" + ": ";
      for(i in positions) {
        var position = positions[i];
        result += position + ", ";
      }
      result = result.substr(0, result.length - 2);
      result += "\n";
    }
    return result;
  }



  </script>

</body>
</html>
