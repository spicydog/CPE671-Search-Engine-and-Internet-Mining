<!DOCTYPE html>
<html>
<head>
  <title>Assignment 1</title>
  <meta charset="UTF-8">
  <script type="text/javascript" src="jquery.min.js"></script>
  <style type="text/css">
  body {
    margin-left: 120px;
    margin-right: 120px;
  }
  .document {
    width: 20%;
    float:left;
  }
  .result {
    width: 100%;
    height: 300px;
  }

  .overlay {
    background-color: #ffffff;
    position:absolute;
    padding: 8px;
    top:0;
    left:0;
    width:100%;
    height:100%;
    z-index:1000;
  }
  </style>


  <script type="text/javascript">

    var docSources =  [{name:'BeautifulMind'        ,relevant:false},
                       {name:'Gladiator'            ,relevant:false},
                       {name:'Gravity'              ,relevant:true},
                       {name:'Hobbit1'              ,relevant:false},
                       {name:'Interstellar'         ,relevant:true},
                       {name:'Prometheus'           ,relevant:false},
                       {name:'ResidentEvil'         ,relevant:false},
                       {name:'StarWars'             ,relevant:false},
                       {name:'TheFaultInOurStars'   ,relevant:false},
                       {name:'Titanic'              ,relevant:false}];

    var docPath = 'https://raw.githubusercontent.com/spicydog/CPE671-Search-Engine-and-Internet-Mining/master/Assignment%202/data/{NAME}.txt';

  </script>
</head>
<body>

<div id="loading" class="overlay">Loading documents from the internet..</div>


<div id="documents">
<h3>Documents</h3>
<div id="source"></div>
<button id="run_index">Compute Weight</button>
<hr />
</div>

<div id="step5">
  <h3>Compute the Robertson/Sparck Jones weight wt of all the weight t in all the 10 documents using Eq. 6 in the lecture.<a href=""></a><input id="phrase" type="text" placeholder="phrase" />
  <button id="run5">Search!</button><br /><br />
  <pre id="result"></pre>
  <hr />
</div>







<script type="text/javascript">

  var docCount = 0;
  requestRawDocumentFromSources();
  function requestRawDocumentFromSources() {
    docCount = 0;
    $('#source').html('');

    $.ajaxPrefilter( function (options) {
      if (options.crossDomain && jQuery.support.cors) {
        var http = (window.location.protocol === 'http:' ? 'http:' : 'https:');
        options.url = http + '//cors-anywhere.herokuapp.com/' + options.url;
      }
    });


    jQuery.ajaxSetup({async:false});
    for(var i in docSources) {
      var docSource = docSources[i];
      var fullDocPath = docPath.replace('{NAME}',docSource.name);

      if(localStorage.getItem(fullDocPath) && typeof(Storage) !== "undefined") { // Cache hit
        printSource(docSource.name,localStorage.getItem(fullDocPath),docSource.relevant);
      } else {
        $.get(fullDocPath,function (response) { // Request from internet
          if(typeof(Storage) !== "undefined") {
            localStorage.setItem(fullDocPath, response);
          }
          printSource(docSource.name,response,docSource.relevant);
        });
      }
    }
    jQuery.ajaxSetup({async:true});
    $('#loading').hide();
  }

  function printSource(name, text, isRelevance) {
    var html = '';
    var checked = isRelevance?'checked':'';
    html += '<div class="document">';
    html += '<input type="checkbox" id="relevance_'+name+'" '+checked+'>' + name;
    html += ' <br />';
    html += ' <textarea style="width:100%;height:100px;" id="document_'+name+'">'+text+'</textarea>';
    html += '</div>';

    if(++docCount%5==0) {
      html += '<div style="clear: both;"><br /></div>';
    }
    $('#source').append(html);
  }


  var indexedData;
  var dictionary;

  var documents = [];


  // Index documents
  $('#run_index').click(function() {
    // Do index

    globalDictionary = new Array();
    globalDocuments = new Array();
    currentWordIndex = 0;

    $("textarea[id^='document_']").each(function(index) {

      var data = $(this).val();
      data = convertLowerCase(data);
      data = filterSymbols(data);
      documents[index] = data;

      // Tokenization
      var result = tokenize(data,globalDictionary);

      // Get doc boundary
      var doc = docSources[index];
      doc.begin = result.from;
      doc.end = result.to;

      // Check relevant
      var relevantDOMID = $(this).attr('id').replace("document_", "relevance_");
      doc.relevant = $('#'+relevantDOMID).prop("checked");

      globalDocuments.push(doc);

    });

    // console.log(globalDocuments);
    getWeight(globalDictionary,globalDocuments);

    // $('#result').html(printDictionary(globalDictionary,100000));

  });

  var globalDictionary = new Array();
  var globalDocuments = new Array();
  var currentWordIndex = 0;

  function tokenize(data, dictionary) {
    var lines = data.split("\n");
    var k = 0;
    var lineNo = 0;

    var words = data.split(" ");

    var nextIndex = currentWordIndex;

    for(var i in words) {
      var word = words[i];
      if(word.length>0) {
        var index = 0;
        if(dictionary[word] === undefined) {
          dictionary[word] = new Array();
        } else {
          index = dictionary[word].length;
        }
        dictionary[word][index] = nextIndex;
        nextIndex++;
      }
    }


    var fromIndex = currentWordIndex;
    var toIndex = nextIndex - 1;
    currentWordIndex = nextIndex;

    return {from:fromIndex,to:toIndex};
  }


  function getDocID(position) {
    for(var i in globalDocuments) {
      doc = globalDocuments[i];
      if(doc.begin<=position && position<=doc.end) {
        return i;
      }
    }
    return -1;
  }

  function getWeight(dictionary,documents) {
    var Nr = 0;
    var N = 0;
    var Ntr = 0;
    var Nt = 0;

    for(var index in documents) {
      var doc = documents[index];
      if(doc.relevant) {
        Nr++;
      }
      N++;
    }

    for(var term in dictionary) {
      var indices = dictionary[term];
      for(var i in indices) {
        var index = indices[i];
        // console.log(index);
        // console.log(term + " " + index + " " + getDocID(index));
      }
    }
    console.log(documents);
  }


  function convertLowerCase(string) {
    return string.toLowerCase();
  }

  function searchParse(phrase) {
  	phrase = phrase.trim();
    phrase = convertLowerCase(phrase);
    phrase = filterSymbols(phrase);
    words = phrase.split(" ");

    var firstWordIndex = -1;
    var result = new Array();
    while(true) {

      firstWordIndex = next(dictionary[ words[0] ], firstWordIndex);
      if(firstWordIndex<0) {
        break;
      }

      var foundFlag = true;
      for(var i=1;i<words.length;i++) {
        if( next(dictionary[ words[i] ], firstWordIndex+i-1) != firstWordIndex+i ) {
          foundFlag = false;
          break;
        }
      }

      if(foundFlag) {
        var temp = new Array();
        for(var i=0;i<words.length;i++) {
          temp.push(firstWordIndex+i);
        }
        result.push(temp);
      }

      firstWordIndex++;
    }
    return result;
  }


  function next(array,fromIndex) {

    fromIndex += 1;
    // No data
    if(array==undefined || array.length==0) {
      return -1;
    }

    var count = array.length;
    // Only one element
    if(count==1) {
      return array[0] >= fromIndex ? array[0] : -2;
    }

    // Exceed last index
    if(array[count-1] < fromIndex) {
      return -2;
    }

    var begin = 0;
    var end = count-1;
    var pivot = Math.floor((end+begin)/2);

    while(begin<end) {
      if(fromIndex < array[pivot]) {
        end = pivot;
      } else if(fromIndex > array[pivot]) {
        begin = pivot+1;
      } else {
        begin = pivot;
        end = pivot;
      }
      pivot = Math.floor((end+begin)/2);
    }

    return array[pivot];
  }


  function filterSymbols(data) {
    data = data.replace(/[^a-z 0-9]/gi,'');
    return data;
  }


  function printDictionary(dictionary,n) {
    var result = "";
    for(word in dictionary) {
      if(n--<=0)
        break;

      var positions = dictionary[word];
      result += word + " ("+ positions.length +")" + ": ";
      for(i in positions) {
        var position = positions[i];
        result += position + ", ";
      }
      result = result.substr(0, result.length - 2);
      result += "\n";
    }
    return result;
  }



  </script>

</body>
</html>
